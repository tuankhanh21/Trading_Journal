<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Options Trading Journal - GitHub Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .auth-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .auth-section.authenticated {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .auth-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1rem;
            align-items: end;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-indicator.connected {
            background-color: #28a745;
        }

        .status-indicator.disconnected {
            background-color: #dc3545;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }

        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }

        .section {
            background: white;
            margin-bottom: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            background: #34495e;
            color: white;
            padding: 1rem 1.5rem;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .section-content {
            padding: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #555;
        }

        input, select, textarea {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #95a5a6;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-success {
            background: #27ae60;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .trades-table th,
        .trades-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .trades-table th {
            background: #f8f9fa;
            font-weight: bold;
            cursor: pointer;
            user-select: none;
        }

        .trades-table th:hover {
            background: #e9ecef;
        }

        .trades-table tr:hover {
            background: #f8f9fa;
        }

        .status {
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status.open {
            background: #fff3cd;
            color: #856404;
        }

        .status.closed {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status.expired {
            background: #f8d7da;
            color: #721c24;
        }

        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .note-preview {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .label-tag {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: #667eea;
            color: white;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            font-size: 0.9rem;
            z-index: 1000;
        }

        .sync-status.syncing {
            background: #fff3cd;
            color: #856404;
        }

        .sync-status.synced {
            background: #d4edda;
            color: #155724;
        }

        .sync-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-section {
                grid-template-columns: 1fr;
            }

            .auth-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“ˆ Options Trading Journal</h1>
            <p>GitHub-Powered - Access Your Data Anywhere</p>
        </div>

        <div class="sync-status" id="syncStatus" style="display: none;"></div>

        <div class="auth-section" id="authSection">
            <div class="auth-form">
                <div class="form-group">
                    <label for="githubToken">GitHub Personal Access Token</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                </div>
                <div class="form-group">
                    <label for="repoName">Repository Name</label>
                    <input type="text" id="repoName" placeholder="options-trading-journal">
                </div>
                <div class="form-group">
                    <button onclick="journal.authenticateGitHub()" class="btn" id="authBtn">
                        <span class="status-indicator disconnected"></span>Connect to GitHub
                    </button>
                </div>
            </div>
            <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                Need a token? Go to GitHub Settings â†’ Developer settings â†’ Personal access tokens â†’ Generate new token (classic) with 'repo' scope.
            </p>
        </div>

        <div id="appContent" style="display: none;">
            <div class="dashboard" id="dashboard">
                <!-- Dashboard metrics will be populated here -->
            </div>

            <div class="section">
                <div class="section-header">Add New Trade</div>
                <div class="section-content">
                    <form id="tradeForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="orderType">Order Type</label>
                                <select id="orderType" required>
                                    <option value="">Select Type</option>
                                    <option value="Buy">Buy</option>
                                    <option value="Sell">Sell</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="symbol">Symbol</label>
                                <input type="text" id="symbol" placeholder="e.g., AAPL" required>
                            </div>
                            <div class="form-group">
                                <label for="strike">Strike Price</label>
                                <input type="number" id="strike" step="0.01" placeholder="150.00" required>
                            </div>
                            <div class="form-group">
                                <label for="currentDate">Entry Date</label>
                                <input type="date" id="currentDate" required>
                            </div>
                            <div class="form-group">
                                <label for="expiredDate">Expiration Date</label>
                                <input type="date" id="expiredDate" required>
                            </div>
                            <div class="form-group">
                                <label for="cost">Cost</label>
                                <input type="number" id="cost" step="0.01" placeholder="500.00" required>
                            </div>
                            <div class="form-group">
                                <label for="profit">Profit (Leave empty for open positions)</label>
                                <input type="number" id="profit" step="0.01" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label for="label">Label</label>
                                <input type="text" id="label" placeholder="e.g., Earnings Play, Technical Breakout">
                            </div>
                            <div class="form-group full-width">
                                <label for="note">Notes</label>
                                <textarea id="note" placeholder="Enter your thoughts, strategy, or observations about this trade..."></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn">Add Trade</button>
                    </form>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Import/Export Trades</div>
                <div class="section-content">
                    <div style="margin-bottom: 1rem;">
                        <input type="file" id="csvFile" accept=".csv" style="display: none;">
                        <button onclick="document.getElementById('csvFile').click()" class="btn">Import CSV</button>
                        <button onclick="journal.exportCSV()" class="btn btn-secondary">Export CSV</button>
                        <button onclick="journal.downloadTemplate()" class="btn btn-secondary">Download Template</button>
                        <button onclick="journal.syncData()" class="btn btn-success">
                            <span id="syncBtnText">Sync with GitHub</span>
                        </button>
                    </div>
                    <p style="color: #666; font-size: 0.9rem;">
                        CSV should include columns: Order Type, Symbol, Strike, Current Date, Expired Date, Cost, Profit, Label, Note
                    </p>
                </div>
            </div>

            <div class="section">
                <div class="section-header">Trading History</div>
                <div class="section-content">
                    <div class="filter-section">
                        <div class="form-group">
                            <label for="filterSymbol">Filter by Symbol</label>
                            <input type="text" id="filterSymbol" placeholder="Enter symbol">
                        </div>
                        <div class="form-group">
                            <label for="filterStatus">Filter by Status</label>
                            <select id="filterStatus">
                                <option value="">All Trades</option>
                                <option value="Open">Open Positions</option>
                                <option value="Closed">Closed Positions</option>
                                <option value="Expired">Expired</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filterLabel">Filter by Label</label>
                            <input type="text" id="filterLabel" placeholder="Enter label">
                        </div>
                        <div class="form-group">
                            <button onclick="journal.applyFilters()" class="btn">Apply Filters</button>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="trades-table" id="tradesTable">
                            <thead>
                                <tr>
                                    <th onclick="journal.sortTable(0)">Order Type</th>
                                    <th onclick="journal.sortTable(1)">Symbol</th>
                                    <th onclick="journal.sortTable(2)">Strike</th>
                                    <th onclick="journal.sortTable(3)">Entry Date</th>
                                    <th onclick="journal.sortTable(4)">Expiration</th>
                                    <th onclick="journal.sortTable(5)">Cost</th>
                                    <th onclick="journal.sortTable(6)">Profit</th>
                                    <th onclick="journal.sortTable(7)">Status</th>
                                    <th onclick="journal.sortTable(8)">Label</th>
                                    <th onclick="journal.sortTable(9)">Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tradesBody">
                                <!-- Trades will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class GitHubTradingJournal {
            constructor() {
                this.trades = [];
                this.githubToken = '';
                this.repoOwner = '';
                this.repoName = '';
                this.authenticated = false;
                this.dataFile = 'trading-data.json';
                this.initializeEventListeners();
                this.loadCredentials();
                this.setDefaultDate();
            }

            loadCredentials() {
                const saved = localStorage.getItem('github_credentials');
                if (saved) {
                    const creds = JSON.parse(saved);
                    document.getElementById('githubToken').value = creds.token || '';
                    document.getElementById('repoName').value = creds.repo || '';
                }
            }

            saveCredentials() {
                const creds = {
                    token: this.githubToken,
                    repo: this.repoName
                };
                localStorage.setItem('github_credentials', JSON.stringify(creds));
            }

            async authenticateGitHub() {
                const token = document.getElementById('githubToken').value.trim();
                const repo = document.getElementById('repoName').value.trim();

                if (!token || !repo) {
                    alert('Please enter both GitHub token and repository name');
                    return;
                }

                this.showSyncStatus('Connecting to GitHub...', 'syncing');
                
                try {
                    // Test authentication by getting user info
                    const response = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Invalid GitHub token');
                    }

                    const user = await response.json();
                    this.repoOwner = user.login;
                    this.githubToken = token;
                    this.repoName = repo;
                    this.authenticated = true;

                    this.saveCredentials();
                    this.updateAuthUI();
                    await this.loadDataFromGitHub();
                    this.showSyncStatus('Connected to GitHub!', 'synced');
                    
                    setTimeout(() => this.hideSyncStatus(), 3000);

                } catch (error) {
                    console.error('Authentication failed:', error);
                    this.showSyncStatus('Authentication failed', 'error');
                    alert('Failed to connect to GitHub. Please check your token and repository name.');
                    setTimeout(() => this.hideSyncStatus(), 5000);
                }
            }

            updateAuthUI() {
                const authSection = document.getElementById('authSection');
                const appContent = document.getElementById('appContent');
                const authBtn = document.getElementById('authBtn');
                const indicator = authBtn.querySelector('.status-indicator');

                if (this.authenticated) {
                    authSection.classList.add('authenticated');
                    authBtn.innerHTML = `<span class="status-indicator connected"></span>Connected as ${this.repoOwner}`;
                    appContent.style.display = 'block';
                } else {
                    authSection.classList.remove('authenticated');
                    authBtn.innerHTML = '<span class="status-indicator disconnected"></span>Connect to GitHub';
                    appContent.style.display = 'none';
                }
            }

            showSyncStatus(message, type) {
                const status = document.getElementById('syncStatus');
                status.textContent = type === 'syncing' ? `â³ ${message}` : 
                                   type === 'synced' ? `âœ… ${message}` : `âŒ ${message}`;
                status.className = `sync-status ${type}`;
                status.style.display = 'block';
            }

            hideSyncStatus() {
                document.getElementById('syncStatus').style.display = 'none';
            }

            async loadDataFromGitHub() {
                if (!this.authenticated) return;

                try {
                    const response = await fetch(
                        `https://api.github.com/repos/${this.repoOwner}/${this.repoName}/contents/${this.dataFile}`,
                        {
                            headers: {
                                'Authorization': `token ${this.githubToken}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );

                    if (response.ok) {
                        const fileData = await response.json();
                        const content = atob(fileData.content);
                        this.trades = JSON.parse(content);
                    } else if (response.status === 404) {
                        // File doesn't exist yet, start with sample data
                        this.trades = this.getSampleData();
                        await this.saveDataToGitHub();
                    }
                    
                    this.updateDisplay();
                } catch (error) {
                    console.error('Failed to load data from GitHub:', error);
                    this.trades = this.getSampleData();
                    this.updateDisplay();
                }
            }

            async saveDataToGitHub() {
                if (!this.authenticated) return;

                this.showSyncStatus('Saving to GitHub...', 'syncing');

                try {
                    // First, try to get the current file to get its SHA
                    let sha = null;
                    try {
                        const response = await fetch(
                            `https://api.github.com/repos/${this.repoOwner}/${this.repoName}/contents/${this.dataFile}`,
                            {
                                headers: {
                                    'Authorization': `token ${this.githubToken}`,
                                    'Accept': 'application/vnd.github.v3+json'
                                }
                            }
                        );
                        if (response.ok) {
                            const fileData = await response.json();
                            sha = fileData.sha;
                        }
                    } catch (e) {
                        // File might not exist, that's okay
                    }

                    // Prepare the data
                    const content = btoa(JSON.stringify(this.trades, null, 2));
                    const body = {
                        message: `Update trading data - ${new Date().toISOString()}`,
                        content: content,
                        branch: 'main'
                    };

                    if (sha) {
                        body.sha = sha;
                    }

                    // Save the file
                    const response = await fetch(
                        `https://api.github.com/repos/${this.repoOwner}/${this.repoName}/contents/${this.dataFile}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${this.githubToken}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(body)
                        }
                    );

                    if (response.ok) {
                        this.showSyncStatus('Saved to GitHub!', 'synced');
                        setTimeout(() => this.hideSyncStatus(), 3000);
                    } else {
                        throw new Error('Failed to save to GitHub');
                    }

                } catch (error) {
                    console.error('Failed to save data to GitHub:', error);
                    this.showSyncStatus('Save failed', 'error');
                    setTimeout(() => this.hideSyncStatus(), 5000);
                }
            }

            getSampleData() {
                return [
                    {
                        id: 1,
                        orderType: 'Buy',
                        symbol: 'AAPL',
                        strike: 150,
                        currentDate: '2024-01-15',
                        expiredDate: '2024-02-16',
                        cost: 500,
                        profit: 150,
                        label: 'Earnings Play',
                        note: 'Bullish on Q4 earnings. Expecting revenue beat due to strong iPhone sales.'
                    },
                    {
                        id: 2,
                        orderType: 'Sell',
                        symbol: 'TSLA',
                        strike: 200,
                        currentDate: '2024-01-20',
                        expiredDate: '2024-03-15',
                        cost: 750,
                        profit: null,
                        label: 'Technical Breakout',
                        note: 'Sold covered calls above resistance. High IV makes this attractive.'
                    }
                ];
            }

            setDefaultDate() {
                document.getElementById('currentDate').value = new Date().toISOString().split('T')[0];
            }

            initializeEventListeners() {
                document.getElementById('tradeForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addTrade();
                });

                document.getElementById('csvFile').addEventListener('change', (e) => {
                    this.importCSV(e);
                });

                ['filterSymbol', 'filterStatus', 'filterLabel'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => {
                        this.applyFilters();
                    });
                });
            }

            async addTrade() {
                const trade = {
                    id: Date.now(),
                    orderType: document.getElementById('orderType').value,
                    symbol: document.getElementById('symbol').value.toUpperCase(),
                    strike: parseFloat(document.getElementById('strike').value),
                    currentDate: document.getElementById('currentDate').value,
                    expiredDate: document.getElementById('expiredDate').value,
                    cost: parseFloat(document.getElementById('cost').value),
                    profit: document.getElementById('profit').value ? parseFloat(document.getElementById('profit').value) : null,
                    label: document.getElementById('label').value,
                    note: document.getElementById('note').value
                };

                this.trades.push(trade);
                await this.saveDataToGitHub();
                this.updateDisplay();
                document.getElementById('tradeForm').reset();
                this.setDefaultDate();
            }

            async deleteTrade(id) {
                if (confirm('Are you sure you want to delete this trade?')) {
                    this.trades = this.trades.filter(trade => trade.id !== id);
                    await this.saveDataToGitHub();
                    this.updateDisplay();
                }
            }

            async closePosition(id) {
                const profit = prompt('Enter the profit/loss for this trade:');
                if (profit !== null) {
                    const trade = this.trades.find(t => t.id === id);
                    if (trade) {
                        trade.profit = parseFloat(profit);
                        await this.saveDataToGitHub();
                        this.updateDisplay();
                    }
                }
            }

            async syncData() {
                await this.loadDataFromGitHub();
            }

            getTradeStatus(trade) {
                if (trade.profit !== null) return 'Closed';
                const today = new Date();
                const expiry = new Date(trade.expiredDate);
                return expiry < today ? 'Expired' : 'Open';
            }

            updateDashboard() {
                const totalTrades = this.trades.length;
                const closedTrades = this.trades.filter(t => t.profit !== null);
                const winningTrades = closedTrades.filter(t => t.profit > 0);
                const winRate = closedTrades.length > 0 ? (winningTrades.length / closedTrades.length * 100).toFixed(1) : 0;
                const totalPL = closedTrades.reduce((sum, t) => sum + (t.profit || 0), 0);
                const avgProfit = closedTrades.length > 0 ? (totalPL / closedTrades.length).toFixed(2) : 0;

                document.getElementById('dashboard').innerHTML = `
                    <div class="metric-card">
                        <div class="metric-value">${totalTrades}</div>
                        <div class="metric-label">Total Trades</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value ${winRate >= 50 ? 'positive' : 'negative'}">${winRate}%</div>
                        <div class="metric-label">Win Rate</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value ${totalPL >= 0 ? 'positive' : 'negative'}">$${totalPL.toFixed(2)}</div>
                        <div class="metric-label">Total P&L</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value ${avgProfit >= 0 ? 'positive' : 'negative'}">$${avgProfit}</div>
                        <div class="metric-label">Avg Profit/Trade</div>
                    </div>
                `;
            }

            updateTradesTable(tradesToShow = this.trades) {
                const tbody = document.getElementById('tradesBody');
                tbody.innerHTML = tradesToShow.map(trade => {
                    const status = this.getTradeStatus(trade);
                    const profitDisplay = trade.profit !== null ? `$${trade.profit.toFixed(2)}` : 'Open';
                    const profitClass = trade.profit !== null ? (trade.profit >= 0 ? 'positive' : 'negative') : '';
                    
                    return `
                        <tr>
                            <td>${trade.orderType}</td>
                            <td>${trade.symbol}</td>
                            <td>$${trade.strike.toFixed(2)}</td>
                            <td>${trade.currentDate}</td>
                            <td>${trade.expiredDate}</td>
                            <td>$${trade.cost.toFixed(2)}</td>
                            <td class="${profitClass}">${profitDisplay}</td>
                            <td><span class="status ${status.toLowerCase()}">${status}</span></td>
                            <td>${trade.label ? `<span class="label-tag">${trade.label}</span>` : ''}</td>
                            <td class="note-preview" title="${trade.note || ''}">${trade.note || ''}</td>
                            <td>
                                <div class="action-buttons">
                                    ${trade.profit === null ? `<button onclick="journal.closePosition(${trade.id})" class="btn btn-success btn-small">Close</button>` : ''}
                                    <button onclick="journal.deleteTrade(${trade.id})" class="btn btn-danger btn-small">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            applyFilters() {
                const symbolFilter = document.getElementById('filterSymbol').value.toLowerCase();
                const statusFilter = document.getElementById('filterStatus').value;
                const labelFilter = document.getElementById('filterLabel').value.toLowerCase();

                const filtered = this.trades.filter(trade => {
                    const matchesSymbol = !symbolFilter || trade.symbol.toLowerCase().includes(symbolFilter);
                    const matchesStatus = !statusFilter || this.getTradeStatus(trade) === statusFilter;
                    const matchesLabel = !labelFilter || (trade.label && trade.label.toLowerCase().includes(labelFilter));
                    
                    return matchesSymbol && matchesStatus && matchesLabel;
                });

                this.updateTradesTable(filtered);
            }

            updateDisplay() {
                this.updateDashboard();
                this.updateTradesTable();
            }

            async importCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                        
                        const requiredHeaders = ['Order Type', 'Symbol', 'Strike', 'Current Date', 'Expired Date', 'Cost'];
                        const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                        
                        if (missingHeaders.length > 0) {
                            alert(`Missing required columns: ${missingHeaders.join(', ')}`);
                            return;
                        }

                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;

                            const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                            const trade = {
                                id: Date.now() + i,
                                orderType: values[headers.indexOf('Order Type')],
                                symbol: values[headers.indexOf('Symbol')].toUpperCase(),
                                strike: parseFloat(values[headers.indexOf('Strike')]),
                                currentDate: values[headers.indexOf('Current Date')],
                                expiredDate: values[headers.indexOf('Expired Date')],
                                cost: parseFloat(values[headers.indexOf('Cost')]),
                                profit: values[headers.indexOf('Profit')] ? parseFloat(values[headers.indexOf('Profit')]) : null,
                                label: values[headers.indexOf('Label')] || '',
                                note: values[headers.indexOf('Note')] || ''
                            };

                            this.trades.push(trade);
                        }

                        await this.saveDataToGitHub();
                        this.updateDisplay();
                        alert('Trades imported successfully!');
                        event.target.value = '';
                    } catch (error) {
                        alert('Error importing CSV: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            exportCSV() {
                const headers = ['Order Type', 'Symbol', 'Strike', 'Current Date', 'Expired Date', 'Cost', 'Profit', 'Label', 'Note'];
                const csvContent = [
                    headers.join(','),
                    ...this.trades.map(trade => [
                        trade.orderType,
                        trade.symbol,
                        trade.strike,
                        trade.currentDate,
                        trade.expiredDate,
                        trade.cost,
                        trade.profit || '',
                        trade.label || '',
                        `"${(trade.note || '').replace(/"/g, '""')}"`
                    ].join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `options_trades_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
            }

            downloadTemplate() {
                const headers = ['Order Type', 'Symbol', 'Strike', 'Current Date', 'Expired Date', 'Cost', 'Profit', 'Label', 'Note'];
                const sampleRow = ['Buy', 'AAPL', '150', '2024-01-15', '2024-02-16', '500', '150', 'Earnings Play', 'Bullish on earnings'];
                const csvContent = [headers.join(','), sampleRow.join(',')].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'options_trading_template.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }

            sortTable(columnIndex) {
                const table = document.getElementById('tradesTable');
                const tbody = table.tBodies[0];
                const rows = Array.from(tbody.rows);

                rows.sort((a, b) => {
                    const aVal = a.cells[columnIndex].textContent.trim();
                    const bVal = b.cells[columnIndex].textContent.trim();

                    if (!isNaN(aVal) && !isNaN(bVal)) {
                        return parseFloat(aVal) - parseFloat(bVal);
                    }

                    return aVal.localeCompare(bVal);
                });

                rows.forEach(row => tbody.appendChild(row));
            }
        }

        // Initialize the journal
        const journal = new GitHubTradingJournal();
    </script>
</body>
</html>
